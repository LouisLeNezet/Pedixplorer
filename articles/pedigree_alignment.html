<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Pedigree alignment details • Pedixplorer</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.9/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Pedigree alignment details">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Pedixplorer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/Pedixplorer.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/pedigree_alignment.html">Pedigree alignment details</a></li>
    <li><a class="dropdown-item" href="../articles/pedigree_kinship.html">Pedigree kinship() details</a></li>
    <li><a class="dropdown-item" href="../articles/pedigree_object.html">Pedigree object</a></li>
    <li><a class="dropdown-item" href="../articles/pedigree_plot.html">Pedigree plotting details</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://github.com/LouisLeNezet/Pedixplorer/releases/tag/v1.1.5">Latest devel release : Version 1.1.5</a></li>
    <li><a class="external-link dropdown-item" href="https://www.bioconductor.org/packages/release/bioc/html/Pedixplorer.html">Latest main release : Version 1.0.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/LouisLeNezet/Pedixplorer/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Pedigree alignment details</h1>
                        <h4 data-toc-skip class="author">TM
Therneau</h4>
            
            <h4 data-toc-skip class="date">25 February, 2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/LouisLeNezet/Pedixplorer/blob/math/vignettes/pedigree_alignment.Rmd" class="external-link"><code>vignettes/pedigree_alignment.Rmd</code></a></small>
      <div class="d-none name"><code>pedigree_alignment.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://louislenezet.github.io/Pedixplorer/">Pedixplorer</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="pedigree-alignment">Pedigree alignment<a class="anchor" aria-label="anchor" href="#pedigree-alignment"></a>
</h2>
<p>An <strong>aligned</strong> Pedigree is an object that contains a
Pedigree along with a set of information that allows for pretty
plotting. This information consists of two parts: a set of vertical and
horizontal plotting coordinates along with the identifier of the subject
to be plotted at each position, and a list of connections to be made
between parent/child, spouse/spouse, and twin/twin.</p>
<p>Creating this aligment turned out to be one of the more difficult
parts of the project, and is the area where significant further work
could be done.</p>
<p>All the routines in this section completely ignore the <span class="math inline">\(id\)</span> component of a Pedigree; everyone is
indexed solely by their row number in the object.</p>
</div>
<div class="section level2">
<h2 id="hints">Hints<a class="anchor" aria-label="anchor" href="#hints"></a>
</h2>
<p>The first part of the work has to do with a <strong>hints</strong>
list for each Pedigree. It consists of 3 parts:</p>
<ul>
<li>The left to right order in which founders should be processed.</li>
<li>The order in which siblings should be listed within a family.</li>
<li>For selected spouse pairs, who is on the left/right, and which of
the two should be the anchor, i.e., determine where the marriage is
plotted.</li>
</ul>
<p>The default starting values for all of these are simple: founders are
processed in the order in which they appear in the data set, children
appear in the order they are found in the data set, husbands are to the
left of their wives, and a marriage is plotted at the leftmost spouse. A
simple example where we want to bend these rules is when two families
marry, and the Pedigrees for both extend above the wedded pair. In the
joint Pedigree the pair should appear as the right-most child in the
left hand family, and as the left-most child in the right hand family.
With respect to founders, assume that a family has three lineages with a
marriage between 1 and 2, and another between 2 and 3. In the joint
Pedigree the sets should be 1, 2, 3 from left to right.</p>
<p>The hints consist of a list with two components.</p>
<ol style="list-style-type: decimal">
<li>A vector of numbers of the same length as the Pedigree, used to
order the female founders and to order siblings within family. For
subjects not part of either of these the value can be arbitrary.</li>
<li>A 3 column matrix of spouse pairs, each row indicates the left-hand
member of the pair, the right-hand member, and which of the two is the
anchor, i.e., directly connected to their parent. Double and triple
marriages can start to get interesting.</li>
</ol>
</div>
<div class="section level2">
<h2 id="auto_hint">Auto_hint<a class="anchor" aria-label="anchor" href="#auto_hint"></a>
</h2>
<p>This routine is used to create an initial hints list. It is a part of
the general intention to make the routine do pretty good drawings
automatically. The basic algorithm is trial and error.</p>
<ul>
<li>Start with the simplest possible hints (user input is accepted)</li>
<li>Call align to see how this works out</li>
<li>Fix any spouses that are not next to each other but could be.</li>
<li>Any fix on the top level mixes up everything below, so we do the
fixes one level at a time.</li>
</ul>
<p>The routine makes no attempt to reorder founders. It just is not
smart enough to figure that out.</p>
<p>The first thing to be done is to check on twins. They increase the
complexity, since twins need to move together. The
<code>rel(ped, "code")</code> object is a factor, so first turn that
into numeric. We create 3 vectors:</p>
<ul>
<li>
<span class="math inline">\(twinrel\)</span> is a matrix containing
pairs of twins and their relation, it is a subset of the incoming <span class="math inline">\(rel\)</span> dataframe.</li>
<li>
<span class="math inline">\(twinset\)</span> vector identifies
twins, it is 0 for anyone who is not a part of a multiple-birth set, and
a unique id for each member of a set. We use the minimum row number of
the members of the set as the id.</li>
<li>
<span class="math inline">\(twinord\)</span> is a starting order
vector for the set; it mostly makes sure that there are no ties (who
knows what a user may have used for starting values.)</li>
</ul>
<p>A recent addition is to carry forward packaged and align to kindepth
and align.</p>
<div class="section level3">
<h3 id="shift-in-auto_hint">Shift in auto_hint<a class="anchor" aria-label="anchor" href="#shift-in-auto_hint"></a>
</h3>
<p>Next is an internal function that rearranges someone to be the
leftmost or rightmost of his/her siblings. The only real complication is
twins. If one of them moves the other has to move too. And we need to
keep the monozygotics together within a band of triplets.</p>
<p><em>Algorithm</em> : if the person to be moved is part of a twinset,
first move all the twins to the left end (or right as the case may be),
then move all the monozygotes to the left, then move the subject himself
to the left.</p>
</div>
<div class="section level3">
<h3 id="init-auto_hint">Init auto_hint<a class="anchor" aria-label="anchor" href="#init-auto_hint"></a>
</h3>
<p>Now, get an ordering of the Pedigree to use as the starting point.
The numbers start at 1 on each level. We do not need the final
<em>prettify</em> step, hence <code>align = FALSE</code>. If there is a
hints structure entered, we retain its non-zero entries, otherwise
people are put into the order of the data set.</p>
<p>We allow the hints input to be only an order vector. twins are then
further reordered.</p>
</div>
<div class="section level3">
<h3 id="fixup-auto_hint">Fixup auto_hint<a class="anchor" aria-label="anchor" href="#fixup-auto_hint"></a>
</h3>
<p>The result coming back from <code><a href="../reference/align.html">align()</a></code> is a set of vectors
and matrices:</p>
<ul>
<li>
<span class="math inline">\(n\)</span> vector, number of entries per
level</li>
<li>
<span class="math inline">\(nid\)</span> matrix, one row per level,
numeric id of the subject plotted here</li>
<li>
<span class="math inline">\(spouse\)</span> integer matrix, one row
per level, subject directly to my right is my spouse (1), a double
marriage (2), or neither (0).</li>
<li>
<span class="math inline">\(fam\)</span> matrix, link upward to my
parents, or 0 if no link.</li>
</ul>
<p><img src="pedigree_alignment_files/figure-html/auto_hint1-1.png" alt="Comparison of auto_hint on a simple pedigree" width="960"><img src="pedigree_alignment_files/figure-html/auto_hint1-2.png" alt="Comparison of auto_hint on a simple pedigree" width="960"></p>
<p>Now, walk down through the levels one by one. A candidate subject is
one who appears twice on the level, once under his/her parents and once
somewhere else as a spouse. Move this person and spouse the the ends of
their sibships and add a marriage hint. The figure above shows a simple
case. The input data set has the subjects ordered from 1–11, the left
panel is the result without hints which processes subjects in the order
encountered. The return values from <a href="#align">align</a> have
subject 9 shown twice. The first is when he is recognized as the spouse
of subject 4, the second as the child of 6–7.</p>
<p>The basic logic is</p>
<ul>
<li>Find a subject listed multiple times on a line (assume it is a
male). This means that he has multiple connections, usually one to his
parents and the other to a spouse tied to her parents. (If the spouse
were a marry-in she would have been placed alongside and there would be
no duplication.)</li>
<li>Say subject x is listed at locations 2, 8, and 12. We look at one
pairing at a time, either 2-8 or 8-12. Consider the first one.
<ul>
<li>If position 2 is associated with siblings, rearrange them to put
subject 2 on the right. If it is associated with a spouse at this
location, put that spouse on the right of her siblings.</li>
<li>Repeat the work for position 8, but moving targets to the left.</li>
<li>At either position, if it is associated with a spouse then add a
marriage. If both ends of the marriage are anchored, i.e., connected to
a family, then either end may be listed as the anchor in the output;
follow the suggestion of the duporder routine. If only one is, it is
usually better to anchor it there, so that the marriage is processed by
<a href="#align">align</a> when that family is. (At least I think
so.)</li>
</ul>
</li>
</ul>
<p>This logic works 9 times out of 10, at least for human pedigrees.
We’ll look at more complex cases below when looking at the <span class="math inline">\(duporder\)</span> (order the duplicates) function,
which returns a matrix with columns 1 and 2 being a pair of duplicates,
and 3 a direction. Note that in the following code <span class="math inline">\(idlist\)</span> refers to the row numbers of each
subject in the Pedigree, not to their label
<code>ped(ped, "id")</code>.</p>
</div>
<div class="section level3">
<h3 id="duporder">duporder<a class="anchor" aria-label="anchor" href="#duporder"></a>
</h3>
<p>For the case shown in figure above the <a href="#duporder">duporder</a> function will return a single row array
with values <code>(2, 6, 1)</code>, the first two being the positions of
the duplicated subject. The anchor will be 2 since that is the copy
connected to parents The direction is TRUE, since the spouse is to the
left of the anchor point. The id is 9, sibs are 8, 9, 10, and the shift
function will create position hints of 2,1,3, which will cause them to
be listed in the order 9, 8, 10.</p>
<p>The value of spouse is 3 (third position in the row), subjects 3, 4,
and 5 are reordered, and finally the line <code>(4,9,1)</code> is added
to the sptemp matrix. In this particular case the final element could be
a 1 or a 2, since both are connected to their parents.</p>
<p><img src="pedigree_alignment_files/figure-html/align2-1.png" alt="Comparison of auto_hint on a more complex pedigree" width="960"><img src="pedigree_alignment_files/figure-html/align2-2.png" alt="Comparison of auto_hint on a more complex pedigree" width="960"></p>
<p>The figure above shows a more complex case with several arcs. In the
upper left is a double marry-in. The <span class="math inline">\(anchor\)</span> variable in the above code will be
<code>(2,2)</code> since both copies have an anchored spouse. The left
and right sets of sibs are reordered (even though the left one does not
need it), and two lines are added to the sptemp matrix:
<code>(5,11,1)</code> and <code>(11,9,2)</code>.</p>
<p>On the upper right is a pair of overlapping arcs. In the final tree
we want to put sibling 28 to the right of 29 since that will allow one
node to join, but if we process the subjects in lexical order the code
will first shift 28 to the right and then later shift over 29. The
duporder function tries to order the duplicates into a matrix so that
the closest ones are processed last. The definition of close is based
first on whether the families touch, and second on the actual distance.
The third column of the matrix hints at whether the marriage should be
plotted at the left (1) or right (2) position of the pair. The goal for
this is to spread apart families of cousins; in the example to not have
the children of 28/31 plotted under the 21/22 grandparents, and those
for 29/32 under the 25/26 grandparents. The logic for this column is
very ad hoc: put children near the edges.</p>
</div>
<div class="section level3">
<h3 id="find-spouse-and-find-sibs">Find-spouse and find-sibs<a class="anchor" aria-label="anchor" href="#find-spouse-and-find-sibs"></a>
</h3>
<p>Finally, here are two helper routines. Finding my spouse can be
interesting – suppose we have a listing with Shirley, Fred, Carl, me on
the line with the first three marked as <code>spouse = TRUE</code> – it
means that she has been married to all 3 of us. First we find the string
from rpos to lpos that is a marriage block; 99% of the time this will be
of length 2 of course. Then find the person in that block who is
opposite sex, and check that they are connected. The routine is called
with a left-right position in the alignment arrays and returns a
position.</p>
<p>The findsibs function starts with a position and returns a position
as well, and is much simpler than findspouse.</p>
</div>
<div class="section level3">
<h3 id="fixup2">Fixup2<a class="anchor" aria-label="anchor" href="#fixup2"></a>
</h3>
<p>At this point the most common situation will be what is shown in
figure. The variable <span class="math inline">\(anchor\)</span> is
<code>(2,1)</code> showing that the left hand copy of subject 9 is
connected to an anchored spouse and the right hand copy is himself
anchored. The proper addition to the spouselist is
<code>(4, 9, dpairs)</code>, where the last is the hint from the dpairs
routine as to which of the parents is the one to follow further when
drawing the entire Pedigree. (When drawing a Pedigree and there is a
child who can be reached from multiple founders, we only want to find
the child once.)</p>
<p>The double marry-in found in the figure, subject 11, leads to value
of <code>(2,2)</code> for the <span class="math inline">\(anchor\)</span> variable. The proper addition to
the <span class="math inline">\(sptemp\)</span> matrix in this case will
be two rows, <code>(5, 11, 1)</code> indicating that 5 should be plotted
left of 11 for the 5-11 marriage, with the first partner as the anchor,
and a second row <code>(11, 9, 2)</code>. This will cause the common
spouse to be plotted in the middle.</p>
<p><img src="pedigree_alignment_files/figure-html/align3-1.png" alt="Horizontal ordering impact" width="960"><img src="pedigree_alignment_files/figure-html/align3-2.png" alt="Horizontal ordering impact" width="960"></p>
<p>Multiple marriages can lead to unanchored subjects. In the left hand
portion of the figure above we have two double marriages, one on the
left and one on the right with anchor values of <code>(0,2)</code> and
<code>(2,0)</code>, respectively. We add two marriages to the return
list to ensure that both print in the correct left-right order; the 14-4
one is correct by default but it is easier to output a line than check
sex orders.</p>
<p>The left panel of the figure above shows a case where subject 11
marries into the Pedigree but also has a second spouse. The <span class="math inline">\(anchor\)</span> variable for this case will be
<code>(2, 0)</code>; the first instance of 11 has a spouse tied into the
tree above, the second instance has no upward connections. In the top
row, subject 6 has values of <code>(0, 0)</code> since neither
connection has an upward parent. In the right hand panel subject 2 has
an anchor variable of <code>(0,1)</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="align">Align<a class="anchor" aria-label="anchor" href="#align"></a>
</h2>
<p>The top level routine for alignment has 5 arguments</p>
<ul>
<li>
<span class="math inline">\(ped\)</span> a Pedigree. In the case of
multiple families we loop over each family separately.</li>
<li>
<span class="math inline">\(packed\)</span> do we allow branches of
the tree to overlap? If FALSE the drawing is much easier, but final
drawing can take up a huge amount of space.</li>
<li>
<span class="math inline">\(width\)</span> the minimum width for a
packed Pedigree. This affects only small pedigrees, since the minimum
possible width for a Pedigree is the largest number of individiuals in
one of the generations.</li>
<li>
<span class="math inline">\(align\)</span> should the final step of
alignment be done? This tries to center children under parents, to the
degree possible.</li>
<li>
<span class="math inline">\(hints\)</span> object. This is normally
blank and auto_hint is invoked.</li>
</ul>
<p>The result coming back from align is a set of vectors and
matrices:</p>
<ul>
<li>
<span class="math inline">\(n\)</span> vector, number of entries per
level</li>
<li>
<span class="math inline">\(nid\)</span> matrix, one row per level,
numeric id of the subject plotted here</li>
<li>
<span class="math inline">\(pos\)</span> the horizontal position for
plotting</li>
<li>
<span class="math inline">\(spouse\)</span> integer matrix, one row
per level, subject directly to my right is my spouse (1), a double
marriage (2), or neither (0).</li>
<li>
<span class="math inline">\(fam\)</span> matrix, link upward to my
parents, or 0 if no link.</li>
</ul>
<div class="section level3">
<h3 id="setup1--align">Setup1 -align<a class="anchor" aria-label="anchor" href="#setup1--align"></a>
</h3>
<p>Start with some setup. Throughout this routine the row number is used
as a subject id (ignoring the actual id label).</p>
<ul>
<li>Check that everyone has either two parents or none (a singleton
confuses us).</li>
<li>Verify that the hints are correct.</li>
<li>The relation data frame, if present, has a factor, convert to
numeric.</li>
<li>Create the <span class="math inline">\(spouselist\)</span> array.
This has 4 columns
<ul>
<li>Husband index (4 = 4th person in the Pedigree structure)</li>
<li>Wife index</li>
<li>Plot order: 1 = husband left, 2 = wife left</li>
<li>Anchor: 1 = left member, 2 = right member, 0 = not yet
determined</li>
</ul>
</li>
</ul>
<p>As the routine proceeds a spousal pair can be encountered multiple
times; we take them out of this list when the “connected” member is
added to the Pedigree so that no marriage gets added twice.</p>
<ul>
<li>To detect duplicates on the spouselist we need to create a unique
(but temporary) spouse-pair id using a simple hash.</li>
</ul>
<p>When importing data from auto_hint, that routine’s spouse matrix has
column 1 = subject plotted on the left, 2 = subject plotted on the
right. The <span class="math inline">\(spouselist\)</span> array has
column 1 = husband, 2 = wife. Hence the clumsy looking ifelse below. The
auto_hint format is more congenial to users, who might modify the
output, the spouselist format easier for the code.</p>
</div>
<div class="section level3">
<h3 id="align-founders">Align-founders<a class="anchor" aria-label="anchor" href="#align-founders"></a>
</h3>
<p>The <a href="#align">align</a> routine does the alignment using 3
co-routines:</p>
<ul>
<li>
<a href="#alignped1">alignped1</a> called with a single subject,
returns the subtree founded on this subject, as though it were the only
tree</li>
<li>
<a href="#alignped2">alignped2</a> called with a set of sibs, calls
<a href="#alignped1">alignped1</a> and <a href="#alignped3">alignped3</a> multiple times to create a joint
Pedigree</li>
<li>
<a href="#alignped3">alignped3</a> given two side by side plotting
structures, merge them into a single one</li>
</ul>
<p>Call <a href="#alignped1">alignped1</a> sequentially with each
founder pair and merge the results. A founder pair is a married pair,
neither of which has a father.</p>
</div>
<div class="section level3">
<h3 id="align-finish">Align-finish<a class="anchor" aria-label="anchor" href="#align-finish"></a>
</h3>
<p>Now finish up. There are 4 tasks to do:</p>
<ul>
<li>For convenience the lower level routines kept the spouse and nid
arrays as a single object – unpack them</li>
<li>In the spouse array a 1 in position i indicates that subject i and
i+1 are joined as a marriage. If these two have a common ancestor change
this to a 2, which indicates that a double line should be used in the
plot.</li>
<li>Add twins data to the output.</li>
<li>Do final alignment</li>
</ul>
<div class="section level4">
<h4 id="finish-align2">Finish align(2)<a class="anchor" aria-label="anchor" href="#finish-align2"></a>
</h4>
<p>The twins array is of the same shape as the spouse and nid arrays:
one row per level giving data for the subjects plotted on that row. In
this case they are</p>
<ul>
<li>0 = nothing</li>
<li>1 = the sib to my right is a monzygotic twin,</li>
<li>2 = the sib to my right is a dizygote,</li>
<li>3 = the sib to my right is a twin, unknown zyogosity.</li>
</ul>
</div>
<div class="section level4">
<h4 id="finish-align3">Finish align(3)<a class="anchor" aria-label="anchor" href="#finish-align3"></a>
</h4>
<p>At this point the Pedigree has been arranged, with the positions in
each row going from 1 to (number of subjects in the row). (For a packed
Pedigree, which is the usual case). Having everything pushed to the left
margin is not very pretty, now we fix that. Note that <a href="#alignped4">alignped4</a> wants a T/F spouse matrix: it does not
care about the degree of relationship to the spouse.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="alignped1">alignped1<a class="anchor" aria-label="anchor" href="#alignped1"></a>
</h2>
<p>This is the first of the three co-routines. It is called with a
single subject, and returns the subtree founded on said subject, as
though it were the only tree. We only go down the Pedigree, not up.
Input arguments are</p>
<ul>
<li>
<span class="math inline">\(nid\)</span> the numeric id of the
subject in question</li>
<li>
<span class="math inline">\(dad\)</span> points to the row of the
father, 0=no father in Pedigree</li>
<li>
<span class="math inline">\(mom\)</span> points to the row of the
mother</li>
<li>
<span class="math inline">\(level\)</span> the plotting depth of
each subject</li>
<li>
<span class="math inline">\(horder\)</span> orders the kids within a
sibship</li>
<li>
<span class="math inline">\(packed\)</span> if true, everything is
slid to the left</li>
<li>
<span class="math inline">\(spouselist\)</span> a matrix of spouses
<ul>
<li>col 1 = Pedigree index of the husband</li>
<li>col 2 = Pedigree index of the wife</li>
<li>col 3 = 1 : plot husband to the left, 2 = wife to the left</li>
<li>col 4 = 1 : left member is rooted here, 2 = right member, 0 =
either</li>
</ul>
</li>
</ul>
<p>The return argument is a set of matrices as described in section <a href="#align">align</a>, along with the spouselist matrix. The latter
has marriages removed as they are processed.</p>
<div class="section level3">
<h3 id="alignped1---part1">alignped1 - part1<a class="anchor" aria-label="anchor" href="#alignped1---part1"></a>
</h3>
<p>In this routine the <span class="math inline">\(nid\)</span> array
consists of the final nid array + 1/2 of the final spouse array. The
basic algorithm is simple.</p>
<ul>
<li>Find all of the spouses for which <span class="math inline">\(x\)</span> is the anchor subject. If there are
none then return the trivial tree consisting of <span class="math inline">\(x\)</span> alone.</li>
<li>For each marriage in the set, call <a href="#alignped2">alignped2</a> on the children and add this to the
result.</li>
</ul>
<p>Note that the <span class="math inline">\(spouselist\)</span> matrix
will only contain spouse pairs that are not yet processed. The logic for
anchoring is slightly tricky. First, if row 4 of the spouselist matrix
is 0, we anchor at the first opportunity, i.e. now.. Also note that if
<code>spouselist[,3] == spouselist[,4]</code> it is the husband who is
the anchor (just write out the possibilities).</p>
</div>
<div class="section level3">
<h3 id="alignped1---part2">alignped1 - part2<a class="anchor" aria-label="anchor" href="#alignped1---part2"></a>
</h3>
<p>Create the set of 3 return structures, which will be matrices with
<code>(1 + nspouse)</code> columns. If there are children then other
routines will widen the result.</p>
</div>
<div class="section level3">
<h3 id="alignped1---part3">alignped1 - part3<a class="anchor" aria-label="anchor" href="#alignped1---part3"></a>
</h3>
<p>Now we have a list of spouses that should be dealt with and the the
correponding columns of the spouselist matrix. Create the two
complimentary lists lspouse and rspouse to denote those plotted on the
left and on the right. For someone with lots of spouses we try to split
them evenly. If the number of spouses is odd, then men should have more
on the right than on the left, women more on the right. Any hints in the
spouselist matrix override. We put the undecided marriages closest to
<span class="math inline">\(x\)</span>, then add predetermined ones to
the left and right. The majority of marriages will be undetermined
singletons, for which nleft will be 1 for female (put my husband to the
left) and 0 for male. In one bug found by plotting canine data, lspouse
could initially be empty but <code>length(rspouse)&gt; 1</code>. This
caused <code>nleft&gt;length(indx)</code>. A fix was to not let indx to
be indexed beyond its length, fix by JPS 5/2013.</p>
<div class="section level4">
<h4 id="alignped1---part4">alignped1 - part4<a class="anchor" aria-label="anchor" href="#alignped1---part4"></a>
</h4>
<p>The spouses are in the Pedigree, now look below. For each spouse get
the list of children. If there are any we call <a href="#alignped2">alignped2</a> to generate their tree and then mark the
connection to their parent. If multiple marriages have children we need
to join the trees.</p>
</div>
<div class="section level4">
<h4 id="alignped1---part5">alignped1 - part5<a class="anchor" aria-label="anchor" href="#alignped1---part5"></a>
</h4>
<p>To finish up we need to splice together the tree made up from all the
kids, which only has data from lev+1 down, with the data here. There are
3 cases. The first and easiest is when no children were found. The
second, and most common, is when the tree below is wider than the tree
here, in which case we add the data from this level onto theirs. The
third is when below is narrower, for instance an only child.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="alignped2">alignped2<a class="anchor" aria-label="anchor" href="#alignped2"></a>
</h2>
<p>This routine takes a collection of siblings, grows the tree for each,
and appends them side by side into a single tree. The input arguments
are the same as those to <a href="#alignped1">alignped1</a> with the
exception that <span class="math inline">\(x\)</span> will be a vector.
This routine does nothing to the spouselist matrix, but needs to pass it
down the tree and back since one of the routines called by <a href="#alignped2">alignped2</a> might change the matrix.</p>
<p>The code below has one non-obvious special case. Suppose that two
sibs marry. When the first sib is processed by <a href="#alignped1">alignped1</a> then both partners (and any children)
will be added to the rval structure below. When the second sib is
processed they will come back as a 1 element tree (the marriage will no
longer be on the spouselist), which should <strong>not</strong> be added
onto rval. The rule thus is to not add any 1 element tree whose value
(which must be <code>x[i]</code>) is already in the rval structure for
this level. (Where did Curt Olswold. find these families?)</p>
</div>
<div class="section level2">
<h2 id="alignped3">alignped3<a class="anchor" aria-label="anchor" href="#alignped3"></a>
</h2>
<p>The third alignment co-routine merges two pedigree trees which are
side by side into a single object. The primary special case is when the
rightmost person in the left tree is the same as the leftmost person in
the right tree; we need not plot two copies of the same person side by
side. (When initializing the output structures do not worry about this -
there is no harm if they are a column bigger than finally needed.)
Beyond that the work is simple bookkeeping.</p>
<div class="section level3">
<h3 id="alignped3---slide">alignped3 - slide<a class="anchor" aria-label="anchor" href="#alignped3---slide"></a>
</h3>
<p>For the unpacked case, which is the traditional way to draw a
Pedigree when we can assume the paper is infinitely wide, all parents
are centered over their children. In this case we think if the two trees
to be merged as solid blocks. On input they both have a left margin of
0. Compute how far over we have to slide the right tree.</p>
</div>
<div class="section level3">
<h3 id="alignped3---merge">alignped3 - merge<a class="anchor" aria-label="anchor" href="#alignped3---merge"></a>
</h3>
<p>Now merge the two trees. Start at the top level and work down.</p>
<ul>
<li>If <code>n2 = 0</code>, there is nothing to do</li>
<li>Decide if there is a subject overlap, and if so
<ul>
<li>Set the proper parent id. Only one of the two copies will be
attached and the other will have <code>fam = 0</code>, so
<code>max(fam, fam2)</code> preserves the correct one.</li>
<li>If not packed, set the position. Choose the one connected to a
parent, or midway for a double marriage.</li>
</ul>
</li>
<li>If <code>packed = TRUE</code> determine the amount of slide for this
row. It will be <span class="math inline">\(space\)</span> over from the
last element in the left Pedigree, less overlap.</li>
<li>Move everything over</li>
<li>Fix all the children of this level, right hand Pedigree, to point to
the correct parental position.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="alignped4">alignped4<a class="anchor" aria-label="anchor" href="#alignped4"></a>
</h2>
<p>The alignped4 routine is the final step of alignment. It attempts to
line up children under parents and put spouses and siblings “close” to
each other, to the extent possible within the constraints of page width.
This routine used to be the most intricate and complex of the set, until
I realized that the task could be cast as constrained quadradic
optimization. The current code does necessary setup and then calls the
<span class="math inline">\(quadprog\)</span> function. At one point I
investigated using one of the simpler least-squares routines where <span class="math inline">\(\beta\)</span> is constrained to be non-negative.
However a problem can only be translated into that form if the number of
constraints is less than the number of parameters, which is not true in
this problem.</p>
<p>There are two important parameters for the function. One is the user
specified maximum width. The smallest possible width is the maximum
number of subjects on a line, if the user suggestion is too low it is
increased to that 1 + that amount (to give just a little wiggle room).
The other is a vector of 2 alignment parameters <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>. For each set of siblings <span class="math inline">\(x\)</span> with parents at <span class="math inline">\(p_1\)</span> and <span class="math inline">\(p_2\)</span> the alignment penalty is</p>
<p><span class="math display">\[
    (1/k^a)\sum{i=1}{k} (x_i - \frac{(p_1 + p_2)}{2})^2
\]</span></p>
<p>where <span class="math inline">\(k\)</span> is the number of
siblings in the set. Using the fact that <span class="math inline">\(\sum(x_i-c)^2 = \sum(x_i-\mu)^2 +
k(c-\mu)^2\)</span>, when <span class="math inline">\(a=1\)</span> then
moving a sibship with <span class="math inline">\(k\)</span> sibs one
unit to the left or right of optimal will incur the same cost as moving
one with only 1 or two sibs out of place. If <span class="math inline">\(a=0\)</span> then large sibships are harder to
move than small ones, with the default value <span class="math inline">\(a=1.5\)</span> they are slightly easier to move
than small ones. The rationale for the default is as long as the parents
are somewhere between the first and last siblings the result looks
fairly good, so we are more flexible with the spacing of a large family.
By tethering all the sibs to a single spot they tend are kept close to
each other. The alignment penalty for spouses is <span class="math inline">\(b(x_1 - x_2)^2\)</span>, which tends to keep them
together. The size of <span class="math inline">\(b\)</span> controls
the relative importance of sib-parent and spouse-spouse closeness.</p>
<div class="section level3">
<h3 id="alignped4---part1">alignped4 - part1<a class="anchor" aria-label="anchor" href="#alignped4---part1"></a>
</h3>
<p>We start by adding in these penalties. The total number of parameters
in the alignment problem (what we hand to quadprog) is the set of
<code>sum(n)</code> positions. A work array myid keeps track of the
parameter number for each position so that it is easy to find. There is
one extra penalty added at the end. Because the penalty amount would be
the same if all the final positions were shifted by a constant, the
penalty matrix will not be positive definite; solve.QP does not like
this. We add a tiny amount of leftward pull to the widest line.</p>
</div>
<div class="section level3">
<h3 id="alignped4-part2">alignped4: part2<a class="anchor" aria-label="anchor" href="#alignped4-part2"></a>
</h3>
<p>Next come the constraints. If there are <span class="math inline">\(k\)</span> subjects on a line there will be <span class="math inline">\(k+1\)</span> constraints for that line. The first
point must be <span class="math inline">\(\ge 0\)</span>, each
subesquent one must be at least 1 unit to the right, and the final point
must be <span class="math inline">\(\le\)</span> the max width.</p>
</div>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.4.2 (2024-10-31)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">## Running under: Ubuntu 22.04.4 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] Pedixplorer_1.3.2 BiocStyle_2.32.1 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] gtable_0.3.6          xfun_0.51             bslib_0.9.0          </span></span>
<span><span class="co">##  [4] ggplot2_3.5.1         htmlwidgets_1.6.4     lattice_0.22-6       </span></span>
<span><span class="co">##  [7] quadprog_1.5-8        vctrs_0.6.5           tools_4.4.2          </span></span>
<span><span class="co">## [10] generics_0.1.3        stats4_4.4.2          tibble_3.2.1         </span></span>
<span><span class="co">## [13] pkgconfig_2.0.3       Matrix_1.7-2          data.table_1.17.0    </span></span>
<span><span class="co">## [16] desc_1.4.3            S4Vectors_0.42.1      readxl_1.4.3         </span></span>
<span><span class="co">## [19] lifecycle_1.0.4       compiler_4.4.2        stringr_1.5.1        </span></span>
<span><span class="co">## [22] shinytoastr_2.2.0     textshaping_1.0.0     munsell_0.5.1        </span></span>
<span><span class="co">## [25] httpuv_1.6.15         shinyWidgets_0.9.0    htmltools_0.5.8.1    </span></span>
<span><span class="co">## [28] sass_0.4.9            yaml_2.3.10           lazyeval_0.2.2       </span></span>
<span><span class="co">## [31] plotly_4.10.4         later_1.4.1           pillar_1.10.1        </span></span>
<span><span class="co">## [34] pkgdown_2.1.1         jquerylib_0.1.4       tidyr_1.3.1          </span></span>
<span><span class="co">## [37] DT_0.33               cachem_1.1.0          mime_0.12            </span></span>
<span><span class="co">## [40] tidyselect_1.2.1      digest_0.6.37         stringi_1.8.4        </span></span>
<span><span class="co">## [43] colourpicker_1.3.0    dplyr_1.1.4           purrr_1.0.4          </span></span>
<span><span class="co">## [46] bookdown_0.42         fastmap_1.2.0         grid_4.4.2           </span></span>
<span><span class="co">## [49] colorspace_2.1-1      cli_3.6.4             magrittr_2.0.3       </span></span>
<span><span class="co">## [52] withr_3.0.2           scales_1.3.0          promises_1.3.2       </span></span>
<span><span class="co">## [55] rmarkdown_2.29        httr_1.4.7            gridExtra_2.3        </span></span>
<span><span class="co">## [58] cellranger_1.1.0      ragg_1.3.3            shiny_1.10.0         </span></span>
<span><span class="co">## [61] evaluate_1.0.3        knitr_1.49            shinycssloaders_1.1.0</span></span>
<span><span class="co">## [64] miniUI_0.1.1.1        viridisLite_0.4.2     rlang_1.1.5          </span></span>
<span><span class="co">## [67] Rcpp_1.0.14           xtable_1.8-4          glue_1.8.0           </span></span>
<span><span class="co">## [70] BiocManager_1.30.25   BiocGenerics_0.50.0   jsonlite_1.9.0       </span></span>
<span><span class="co">## [73] R6_2.6.1              plyr_1.8.9            systemfonts_1.2.1    </span></span>
<span><span class="co">## [76] fs_1.6.5</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Louis Le Nezet, Jason Sinnwell, Terry Therneau.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
