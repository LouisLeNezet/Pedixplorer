<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Alignment fourth routine — alignped4 • Pedixplorer</title><script src="../lightswitch.js"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.9/font.css" rel="stylesheet"><link href="../deps/JetBrains_Mono-0.4.9/font.css" rel="stylesheet"><link href="../deps/Roboto_Slab-0.4.9/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet"><script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Alignment fourth routine — alignped4"><meta name="description" content='Last routines which attempts to line up children under parents and put
spouses and siblings "close" to each other, to the extent possible
within the constraints of page width.'><meta property="og:description" content='Last routines which attempts to line up children under parents and put
spouses and siblings "close" to each other, to the extent possible
within the constraints of page width.'></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Pedixplorer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/Pedixplorer.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/pedigree_alignment.html">Pedigree alignment details</a></li>
    <li><a class="dropdown-item" href="../articles/pedigree_kinship.html">Pedigree kinship() details</a></li>
    <li><a class="dropdown-item" href="../articles/pedigree_object.html">Pedigree object</a></li>
    <li><a class="dropdown-item" href="../articles/pedigree_plot.html">Pedigree plotting details</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news"><li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://github.com/LouisLeNezet/Pedixplorer/releases/tag/v1.1.5">Latest devel release : Version 1.1.5</a></li>
    <li><a class="external-link dropdown-item" href="https://www.bioconductor.org/packages/release/bioc/html/Pedixplorer.html">Latest main release : Version 1.0.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/LouisLeNezet/Pedixplorer/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Alignment fourth routine</h1>
      <small class="dont-index">Source: <a href="https://github.com/LouisLeNezet/Pedixplorer/blob/devel/R/alignped4.R" class="external-link"><code>R/alignped4.R</code></a></small>
      <div class="d-none name"><code>alignped4.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Last routines which attempts to line up children under parents and put
spouses and siblings "close" to each other, to the extent possible
within the constraints of page width.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">alignped4</span><span class="op">(</span><span class="va">rval</span>, <span class="va">spouse</span>, <span class="va">level</span>, <span class="va">width</span>, <span class="va">align</span>, precision <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-rval">rval<a class="anchor" aria-label="anchor" href="#arg-rval"></a></dt>
<dd><p>A list with components <code>n</code>, <code>nid</code>,
<code>pos</code>, and <code>fam</code>.</p></dd>


<dt id="arg-spouse">spouse<a class="anchor" aria-label="anchor" href="#arg-spouse"></a></dt>
<dd><p>A boolean matrix with one row per level representing if
the subject is a spouse or not.</p></dd>


<dt id="arg-level">level<a class="anchor" aria-label="anchor" href="#arg-level"></a></dt>
<dd><p>Vector of the level of each subject</p></dd>


<dt id="arg-width">width<a class="anchor" aria-label="anchor" href="#arg-width"></a></dt>
<dd><p>For a packed output, the minimum width of the plot, in
inches.</p></dd>


<dt id="arg-align">align<a class="anchor" aria-label="anchor" href="#arg-align"></a></dt>
<dd><p>For a packed Pedigree, align children under parents <code>TRUE</code>,
to the extent possible given the page width, or align to to the left
margin <code>FALSE</code>.
This argument can be a two element vector, giving the alignment
parameters, or a logical value.
If <code>TRUE</code>, the default is <code>c(1.5, 2)</code>, or if numeric the routine
<code>alignped4()</code> will be called.</p></dd>


<dt id="arg-precision">precision<a class="anchor" aria-label="anchor" href="#arg-precision"></a></dt>
<dd><p>The number of significatif numbers to round the
solution to.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>The updated position matrix</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The <code>alignped4()</code> routine is the final step of alignment.
The current code does necessary setup and then calls the
<code><a href="https://rdrr.io/pkg/quadprog/man/solve.QP.html" class="external-link">quadprog::solve.QP()</a></code> function.</p>
<p>There are two important parameters for the function:</p><ol><li><p>The maximum width specified.
The smallest possible width is the maximum number of subjects on a
line. If the user suggestion is too low it is increased to that
amount plus one (to give just a little wiggle room).</p></li>
<li><p>The align vector of 2 alignment parameters <code>a</code> and <code>b</code>.
For each set of siblings <code>x</code> with parents at <code>p_1</code> and <code>p_2</code>
the alignment penalty is:</p>
<p>$$(1/k^a)\sum_{i=1}^{k} (x_i - (p_1 + p_2)/2)^2$$</p>
<p>where <code>k</code> is the number of siblings in the set.</p></li>
</ol><p>Using the fact that when <code>a = 1</code> :</p>
<p>$$\sum(x_i-c)^2 = \sum(x_i-\mu)^2 + k(c-\mu)^2$$</p>
<p>then moving a sibship with <code>k</code> sibs one unit to the left or
right of optimal will incur the same cost as moving one with only 1 or
two sibs out of place.</p>
<p>If <code>a = 0</code> then large sibships are harder to move
than small ones.
With the default value <code>a = 1.5</code>, they are slightly easier
to move than small ones.
The rationale for the default is as long as the
parents are somewhere between the first and last siblings the result looks
fairly good, so we are more flexible with the spacing of a large family.
By tethering all the sibs to a single spot they tend to be kept close to
each other.</p>
<p>The alignment penalty for spouses is \(b(x_1 - x_2)^2\), which tends to
keep them together. The size of <code>b</code> controls the relative importance of
sib-parent and spouse-spouse closeness.</p><ol><li><p>We start by adding in these penalties.
The total number of parameters in the alignment problem
(what we hand to quadprog) is the set of <code>sum(n)</code> positions.
A work array myid keeps track of the parameter number for each position
so that it is easy to find. There is one extra penalty added at the end.
Because the penalty amount would be the same if all the final positions
were shifted by a constant, the penalty matrix will not be positive
definite; <code>solve.QP()</code> does not like this.
We add a tiny amount of leftward pull to the widest line.</p></li>
<li><p>If there are <code>k</code> subjects on a line there will
be <code>k+1</code> constraints for that line.  The first point must be
\(\ge 0\), each subsequent one must be at least 1 unit to the right,
and the final point must be \(\le\) the max width.</p></li>
</ol></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="align.html">align()</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">sampleped</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">pedi</span> <span class="op">&lt;-</span> <span class="fu"><a href="Pedigree-class.html">Pedigree</a></span><span class="op">(</span><span class="va">sampleped</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="align.html">align</a></span><span class="op">(</span><span class="va">pedi</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`1`</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`1`$n</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1]  2 10 16 14</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`1`$nid</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]   35   36    0    0    0    0    0    0    0     0     0     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]    1    2    3    4   37   38    5    6    7     8     0     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]    9   10   11   12   14   39   40   41   14    15    12    18    17    16</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,]   21   22   23   24   27   28   25   26   29    30    31    32    33    34</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,15] [,16]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]    19    20</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,]     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`1`$pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]  [,9] [,10] [,11] [,12]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 3.804 4.804 0.000 0.000 0.000 0.000  0.00  0.00  0.00  0.00  0.00  0.00</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,] 0.000 1.000 2.804 3.804 4.804 5.804 11.25 12.25 14.01 15.01  0.00  0.00</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,] 0.000 1.000 2.000 3.000 4.000 5.000  6.00  7.00  8.00  9.00 10.00 11.00</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,] 0.000 1.000 2.000 3.000 6.010 7.010  8.01  9.01 10.01 11.01 12.01 13.01</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,13] [,14] [,15] [,16]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]  0.00  0.00     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]  0.00  0.00     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,] 12.00 13.00    14    15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,] 14.01 15.01     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`1`$fam</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]    0    0    1    0    0    1    0    0    0     0     0     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]    1    3    3    3    3    5    5    5    0     7     0     7     0     7</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,]    1    1    1    1    9    9   11   11   13    15    15    15    15    15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,15] [,16]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]     7     9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,]     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`1`$spouse</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]    1    0    0    0    0    0    0    0    0     0     0     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]    1    0    1    0    1    0    1    0    1     0     0     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]    1    0    0    0    0    0    0    0    1     0     1     0     1     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,15] [,16]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]     1     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,]     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`2`</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`2`$n</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 2 7 5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`2`$nid</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,1] [,2] [,3] [,4] [,5] [,6] [,7]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]    1    2    0    0    0    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]    3    4    5    6    7    9    8</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]   10   11   12   13   14    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`2`$pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,1] [,2] [,3] [,4] [,5] [,6] [,7]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]  2.7  3.7  0.0  0.0  0.0    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]  0.0  1.0  2.0  3.0  4.0    5    6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]  0.0  1.0  4.5  5.5  6.5    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`2`$fam</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,1] [,2] [,3] [,4] [,5] [,6] [,7]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]    0    0    0    0    0    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]    0    1    1    1    1    0    1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]    1    1    6    6    6    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`2`$spouse</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,1] [,2] [,3] [,4] [,5] [,6] [,7]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]    1    0    0    0    0    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]    1    0    0    0    0    1    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]    0    0    0    0    0    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Louis Le Nezet, Jason Sinnwell, Terry Therneau.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

